name: Build Mac Application

on:
  push:
    tags:
      - 'v*'  # 当推送以 v 开头的 tag 时触发，例如 v1.0.0
  workflow_dispatch:  # 允许手动触发
    inputs:
      version:
        description: '版本号'
        required: false
        default: '1.0.0'

jobs:
  build-mac:
    strategy:
      matrix:
        arch: [intel, apple-silicon]
        include:
          - arch: intel
            runner: macos-15-intel  # Intel 架构 (x86_64)
            suffix: -Intel
          - arch: apple-silicon
            runner: macos-latest  # Apple Silicon 架构 (arm64)
            suffix: -AppleSilicon
    runs-on: ${{ matrix.runner }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'  # 根据需要调整 Python 版本
    
    - name: Install system dependencies
      run: |
        # 安装 PyQt5 可能需要的系统库
        brew install python-tk@3.11 || true
    
    - name: Create virtual environment
      run: |
        python3 -m venv venv
        source venv/bin/activate
    
    - name: Install Python dependencies
      run: |
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Mac application
      run: |
        source venv/bin/activate
        # 设置最低 macOS 版本为 10.15 (Catalina)，以支持较老的系统
        export MACOSX_DEPLOYMENT_TARGET=10.15
        pyinstaller build_exe_mac.spec
    
    - name: Verify application structure
      run: |
        echo "=== Verifying .app structure (onedir mode) ==="
        
        # 检查 .app 目录是否存在
        if [ ! -d "dist/PDF处理器.app" ]; then
          echo "❌ Error: PDF处理器.app not found!"
          exit 1
        fi
        
        # 检查 Contents 目录
        if [ ! -d "dist/PDF处理器.app/Contents" ]; then
          echo "❌ Error: Contents directory not found!"
          exit 1
        fi
        
        # 检查 MacOS 目录和可执行文件
        if [ ! -d "dist/PDF处理器.app/Contents/MacOS" ]; then
          echo "❌ Error: MacOS directory not found!"
          exit 1
        fi
        
        APP_EXEC="dist/PDF处理器.app/Contents/MacOS/PDF处理器"
        if [ ! -f "$APP_EXEC" ]; then
          echo "❌ Error: Executable file not found!"
          exit 1
        fi
        
        # 检查 onedir 模式的文件结构（应该有 _internal 或 PDF处理器 目录）
        MACOS_DIR="dist/PDF处理器.app/Contents/MacOS"
        if [ -d "$MACOS_DIR/_internal" ] || [ -d "$MACOS_DIR/PDF处理器" ]; then
          echo "✓ onedir structure detected"
          echo "=== Directory structure ==="
          ls -la "$MACOS_DIR" | head -20
        else
          echo "⚠ Warning: onedir structure not found, checking for onefile mode"
          ls -la "$MACOS_DIR"
        fi
        
        # 检查资源文件
        if [ -d "dist/PDF处理器.app/Contents/Resources" ]; then
          echo "=== Resources directory ==="
          ls -la "dist/PDF处理器.app/Contents/Resources/" || echo "Resources directory is empty"
        fi
        
        echo "✓ Application structure is valid"
    
    - name: Test application launch
      run: |
        APP_PATH="dist/PDF处理器.app/Contents/MacOS/PDF处理器"
        
        # 检查可执行文件是否存在
        if [ ! -f "$APP_PATH" ]; then
          echo "❌ Error: Executable not found"
          exit 1
        fi
        
        # 设置执行权限
        chmod +x "$APP_PATH"
        
        # 尝试启动应用（后台运行，3秒后检查进程）
        echo "Testing application launch..."
        "$APP_PATH" &
        APP_PID=$!
        sleep 3
        
        # 检查进程是否在运行（说明应用至少启动了）
        if ps -p $APP_PID > /dev/null; then
          echo "✓ Application started successfully"
          kill $APP_PID 2>/dev/null || true
        else
          # 进程退出可能是正常的（GUI应用在headless环境可能无法运行）
          echo "✓ Application executed (may exit immediately in headless environment)"
        fi
    
    - name: Create DMG (optional)
      run: |
        # 安装 create-dmg（如果需要创建安装包）
        brew install create-dmg || true
        
        # 创建 DMG 安装包（可选）
        if command -v create-dmg &> /dev/null; then
          create-dmg \
            --volname "PDF处理器" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "PDF处理器.app" 200 190 \
            --hide-extension "PDF处理器.app" \
            --app-drop-link 600 185 \
            "PDF处理器.dmg" \
            "dist/" || echo "DMG creation skipped"
        fi
    
    - name: Rename files to English names
      run: |
        # 创建发布目录
        mkdir -p release
        
        # 根据架构添加后缀
        ARCH_SUFFIX="${{ matrix.suffix }}"
        
        # 重命名 .app 文件（目录）
        if [ -d "dist/PDF处理器.app" ]; then
          cp -R "dist/PDF处理器.app" "release/PDFProcessor${ARCH_SUFFIX}.app"
        fi
        
        # 重命名 .dmg 文件
        if [ -f "dist/PDF处理器.dmg" ]; then
          cp "dist/PDF处理器.dmg" "release/PDFProcessor${ARCH_SUFFIX}.dmg"
        fi
        
        # 列出发布目录内容（用于调试）
        echo "=== Release directory contents ==="
        ls -la release/
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PDFProcessor-Mac-${{ matrix.arch }}
        path: |
          release/PDFProcessor${{ matrix.suffix }}.app
          release/PDFProcessor${{ matrix.suffix }}.dmg
        if-no-files-found: warn
        retention-days: 30
    
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/PDFProcessor${{ matrix.suffix }}.app
          release/PDFProcessor${{ matrix.suffix }}.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
