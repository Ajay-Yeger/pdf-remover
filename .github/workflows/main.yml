name: Build Mac Application (Universal2)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: '版本号'
        required: false
        default: '1.0.0'

jobs:
  build-mac-universal2:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        python-version: '3.10'
        channels: conda-forge,defaults
        channel-priority: strict
        auto-activate-base: false
    
    - name: Install official Python Universal2
      run: |
        # 下载并安装官方 Python Universal2 版本
        # 官方 Python 提供 Universal2 支持，包含 arm64 和 x86_64
        PYTHON_URL="https://www.python.org/ftp/python/3.10.2/python-3.10.2-macos11.pkg"
        
        echo "Downloading Python Universal2 installer..."
        curl -L -o python.pkg "$PYTHON_URL"
        
        echo "Installing Python Universal2..."
        sudo installer -pkg python.pkg -target /
        
        # 创建符号链接到 /usr/local/bin（如果不存在）
        sudo mkdir -p /usr/local/bin
        PYTHON_BIN="/Library/Frameworks/Python.framework/Versions/${PYTHON_VERSION}/bin"
        if [ ! -f /usr/local/bin/python3 ]; then
          sudo ln -sf "${PYTHON_BIN}/python3" /usr/local/bin/python3
          sudo ln -sf "${PYTHON_BIN}/pip3" /usr/local/bin/pip3
        fi
        
        # 验证 Python 架构
        /usr/local/bin/python3 --version
        if command -v lipo >/dev/null 2>&1; then
          PYTHON_EXEC="${PYTHON_BIN}/python3"
          ARCH_INFO=$(lipo -info "$PYTHON_EXEC" 2>&1 || echo "Not a fat binary")
          echo "Python architecture: $ARCH_INFO"
          if echo "$ARCH_INFO" | grep -q "x86_64.*arm64\|arm64.*x86_64"; then
            echo "✓ Python is Universal2"
          else
            echo "⚠ Warning: Python may not be Universal2"
          fi
        fi
        
        # 设置 PATH，优先使用官方 Python
        echo "${PYTHON_BIN}" >> $GITHUB_PATH
        echo "PYTHON_BIN=${PYTHON_BIN}" >> $GITHUB_ENV
    
    - name: Install Python dependencies
      run: |
        # 使用官方 Python Universal2 的 pip
        python3 --version
        which python3
        which pip3
        
        pip3 install --upgrade pip
        pip3 install -r requirements.txt
        pip3 install pyinstaller
        
        # 验证安装的包架构
        echo "=== Checking installed package architectures ==="
        python3 -c "import sys; print('Python executable:', sys.executable); print('Python version:', sys.version)"
        
        # 检查关键包的架构（应该是 Universal2）
        python3 -c "import sys, os, subprocess; site_packages = [p for p in sys.path if 'site-packages' in p][0]; print(f'Site packages: {site_packages}'); import PIL; pil_path = os.path.dirname(PIL.__file__); webp_so = os.path.join(pil_path, '_webp.cpython-310-darwin.so'); result = subprocess.run(['lipo', '-info', webp_so], capture_output=True, text=True) if os.path.exists(webp_so) else None; arch_info = result.stdout.strip() if result else None; print(f'PIL._webp architecture: {arch_info}') if arch_info else print('⚠ PIL._webp.so not found'); print('✓ PIL._webp is Universal2') if arch_info and 'x86_64' in arch_info and 'arm64' in arch_info else print('⚠ PIL._webp may not be Universal2') if arch_info else None" 2>&1 || echo "Package architecture check completed"
    
    - name: Build Mac application (Universal2)
      run: |
        # 使用官方 Python Universal2
        python3 --version
        which python3
        
        # 设置 macOS 部署目标为 12.0（支持 macOS 12.7）
        export MACOSX_DEPLOYMENT_TARGET=12.0
        export CFLAGS="-mmacosx-version-min=12.0"
        export CXXFLAGS="-mmacosx-version-min=12.0"
        export LDFLAGS="-mmacosx-version-min=12.0"
        
        # 使用官方 Python Universal2 构建 Universal2 应用
        python3 -m PyInstaller build_exe_mac.spec
        
        # 验证生成的应用架构
        echo "=== Verifying application architecture ==="
        APP_EXEC="dist/PDF处理器.app/Contents/MacOS/PDF处理器"
        if [ -f "$APP_EXEC" ]; then
          if command -v lipo >/dev/null 2>&1; then
            ARCH_INFO=$(lipo -info "$APP_EXEC" 2>&1)
            echo "Application architecture: $ARCH_INFO"
            if echo "$ARCH_INFO" | grep -q "x86_64" && echo "$ARCH_INFO" | grep -q "arm64"; then
              echo "✓ Application is Universal2 (supports both Intel and Apple Silicon)"
            else
              echo "⚠ Warning: Application may not be Universal2"
            fi
          fi
        fi
    
    - name: Fix application permissions and code sign
      run: |
        APP_EXEC="dist/PDF处理器.app/Contents/MacOS/PDF处理器"
        chmod +x "$APP_EXEC"
        codesign --force --deep --sign - "dist/PDF处理器.app" || true
    
    - name: Create DMG
      run: |
        brew install create-dmg || true
        if command -v create-dmg &> /dev/null; then
          create-dmg \
            --volname "PDF处理器" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "PDF处理器.app" 200 190 \
            --hide-extension "PDF处理器.app" \
            --app-drop-link 600 185 \
            "dist/PDF处理器.dmg" \
            "dist/" || echo "DMG creation skipped"
        fi
    
    - name: Rename files to English names
      run: |
        mkdir -p release
        cp -R "dist/PDF处理器.app" "release/PDFProcessor.app"
        chmod +x "release/PDFProcessor.app/Contents/MacOS/PDF处理器"
        codesign --force --deep --sign - "release/PDFProcessor.app" || true
        [ -f "dist/PDF处理器.dmg" ] && cp "dist/PDF处理器.dmg" "release/PDFProcessor.dmg"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PDFProcessor-Mac-Universal2
        path: |
          release/PDFProcessor.app
          release/PDFProcessor.dmg
        if-no-files-found: warn
        retention-days: 30
    
    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/PDFProcessor.app
          release/PDFProcessor.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
