name: Build Mac Application

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-mac-intel:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniconda-version: "latest"
        auto-update-conda: true
        python-version: 3.9
        architecture: x86_64
        activate-environment: build_env
        environment-file: environment.yml  # 可选，如果你有 conda dependencies

    - name: Install system dependencies
      run: |
        brew install gettext pyqt@5
        brew link --force gettext

    - name: Install Python dependencies
      run: |
        conda activate build_env
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Mac application
      run: |
        conda activate build_env
        export MACOSX_DEPLOYMENT_TARGET=12.0
        export CFLAGS="-mmacosx-version-min=12.0"
        export CXXFLAGS="-mmacosx-version-min=12.0"
        export LDFLAGS="-mmacosx-version-min=12.0"

        pyinstaller build_exe_mac.spec

    - name: Fix permissions and code sign
      run: |
        APP_EXEC="dist/PDF处理器.app/Contents/MacOS/PDF处理器"
        chmod +x "$APP_EXEC"
        codesign --force --deep --sign - "dist/PDF处理器.app" || true

    - name: Create DMG (optional)
      run: |
        brew install create-dmg || true
        if command -v create-dmg &> /dev/null; then
          create-dmg \
            --volname "PDF处理器" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "PDF处理器.app" 200 190 \
            --hide-extension "PDF处理器.app" \
            --app-drop-link 600 185 \
            "PDF处理器.dmg" \
            "dist/" || echo "DMG creation skipped"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: PDFProcessor-Mac-Intel
        path: |
          dist/PDF处理器.app
          dist/PDF处理器.dmg
        if-no-files-found: warn
        retention-days: 30
